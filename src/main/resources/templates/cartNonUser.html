<!DOCTYPE html>
<html data-bs-theme="auto" xmlns:th="http//www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layouts/default-without-header}">

<head>
    <title>mavi karga</title>


</head>

<body layout:fragment="content">
    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
        <div
            class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">장바구니 (비회원)</h1>
        </div>


        <form th:action="@{/order/cart/nonuser}" th:object="${cartProductDtoList}" method="post">
            <table>
                <tr th:each="cartProductDto, rowStat : *{cartProductDtoList}">
                    <!-- 상품ID -->
                    <td>
                        <input type="number" th:field="*{cartProductDtoList[__${rowStat.index}__].cartId}"
                            style="display: none;">
                    </td>
                    <!-- 상품 이름 -->
                    <td class="name" th:text="${cartProductDto.name}"></td>
                    <!-- 개당 가격 (안보이도록 처리) -->
                    <td style="display: none;" class="price" th:text="${cartProductDto.price}"></td>
                    <!-- 갯수 수정 input -->
                    <td>
                        <input class="count" th:field="*{cartProductDtoList[__${rowStat.index}__].count}"
                            type="number" />
                    </td>
                    <!-- 계산된 전체 가격 -->
                    <td class="totalPrice"></td>
                    <!-- 상품 제외 버튼 -->
                    <td>
                        <button class="excludeBtn" type="button">제외</button>
                        <!-- 상품 제거 버튼 누르면 deleted=true 로 만듦 -->
                        <input class="deleted" th:field="*{cartProductDtoList[__${rowStat.index}__].deleted}"
                            style="display: none;" type="checkbox">
                    </td>
                </tr>
            </table>
            <button id="submitBtn" type="submit">구매</button>
        </form>

        <!-- divider -->
        <div class="container">
            <hr class="featurette-divider">
        </div>
    </main>


    <script>
        // 사용자가 상품 갯수 변경할때마다 최종 가격 업데이트해서 보여줌
        // 제외 버튼 누르면 해당 행 안보이도록 처리 
        document.addEventListener('DOMContentLoaded', function () {
            const submitBtn = document.getElementById('submitBtn')
            var rows = document.querySelectorAll('tr');
            // 장바구니 상품 갯수 
            var numberOfCartProduct = rows.length;

            rows.forEach(function (row) {
                // 개당 가격 
                var priceCell = row.querySelector('.price');
                // 갯수 
                var countInput = row.querySelector('.count');
                // 최종 가격
                var totalPriceCell = row.querySelector('.totalPrice');
                // 최종 가격
                var excludeBtn = row.querySelector('.excludeBtn');
                // deleted 값
                var deletedCheckbox = row.querySelector('.deleted');

                // 상품 가격 * 갯수 = 총 가격 
                function updateTotalPrice() {
                    var price = parseFloat(priceCell.textContent);
                    var count = parseInt(countInput.value);

                    var totalPrice = price * count;

                    totalPriceCell.textContent = totalPrice;
                }

                // 제외 버튼 누르면 해당 row 안보이도록 처리 
                function excludeProduct() {
                    // 안보이도록 처리 
                    row.style.display = 'none';
                    // 서버에 보낼 데이터
                    deletedCheckbox.checked = true;
                    // 장바구니 상품 갯수 -1
                    numberOfCartProduct--;
                    // 장바구니 상품 갯수가 0이되면 구매 버튼 클릭 불가능하도록 
                    if(numberOfCartProduct === 0) {
                        submitBtn.disabled = true;
                    }
                }

                // count input 이벤트 리스너 
                countInput.addEventListener('input', updateTotalPrice);

                // 제외 버튼 이벤트 리스너 
                excludeBtn.addEventListener('click', excludeProduct);

                // 가격 업데이트 
                updateTotalPrice();
            });
        });

        
    </script>
</body>

</html>