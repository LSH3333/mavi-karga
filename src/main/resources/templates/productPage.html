<!DOCTYPE html>
<html lang="en" xmlns:th="http//www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <div>product page</div>
    <div>
        <p th:text="${orderProductDto.name}"></p>
        <p th:text="${orderProductDto.description}"></p>

        <!-- 로그인 해야 보이는 영역 -->
        <form id="formData" th:action="@{/order/products/add}" sec:authorize="isAuthenticated()"
            th:object="${orderProductDto}" method="post">
            <!-- 사이즈 -->
            <div class="mb-3">
                <label for="size" class="form-label">사이즈</label>
                <select th:field="*{selectedProductSizeId}" id="size" name="size" class="form-select">
                    <option th:each="productSize : ${orderProductDto.productSizeList}" th:text="${productSize.size}"
                        th:value="${productSize.id}">
                    </option>
                </select>
            </div>
            <!-- 갯수 -->
            <div class="mb-3">
                <label for="count">수량</label>
                <input th:field="${orderProductDto.count}" type="number" id="count" name="count" min="1" max="100" />
            </div>
            <button id="submitBtn" type="submit" class="btn btn-primary">Submit</button>
        </form>

        <!-- 로그인 없이 보이는 영역 -->
        <a sec:authorize="isAnonymous()" th:href="@{/login}">구매하기 위해서 로그인해주세요!</a>
    </div>

    <!-- submit form ajax -->
    <script>
        let submitBtn = document.getElementById('submitBtn');
        if (submitBtn != null) {
            submitBtn.addEventListener('click', function (event) {
                event.preventDefault();
                submitForm();
            })

            function submitForm() {
                console.log('submitForm()')
                let formData = new FormData(document.getElementById('formData'))

                const xhr = new XMLHttpRequest();            
                xhr.open("POST", "/order/products/add", true);

                xhr.onload = function () {
                    if (xhr.readyState == XMLHttpRequest.DONE) {
                        if (xhr.status == 200) {
                            // todo: 장바구니 추가 성공 팝업 띄우기 
                            console.log("order success");
                        } else if (xhr.status == 302) {
                            console.log('302')
                        }
                        else {
                            console.log("order failed");
                        }
                    }
                }
                xhr.send(formData);
            };
        }



    </script>

</body>

</html>